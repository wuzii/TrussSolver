function cX(a){return a-$("#canvas").offset().left}function cY(a){return a-$("#canvas").offset().top}function cXr(a){return a+$("#canvas").offset().left}function cYr(a){return a+$("#canvas").offset().top}function coor(a,b,c,d,e){this.type=a;this.x=b;this.y=c;this.x1=b;this.y1=c;this.x2=d;this.y2=e;if(this.type==TYPE_LOAD){this.load_angle=d;this.load_mag=e}}var TYPE_MEMBER=1,TYPE_PIN_SUPPORT=2,TYPE_ROLLER_SUPPORT=3,TYPE_CIRCLE=4,TYPE_LOAD=5;var MEMBER_FILL_COLOR="#0099FF";var PIN_SUPPORT_FILL_COLOR="#330000";var ROLLER_SUPPORT_FILL_COLOR="#666600";var SELECTED_COLOR="#FF0000";var LOAD_STROKE_COLOR="#333333";var PIN_SUPPORT_STYLE={opacity:1};var PIN_SUPPORT_TEMP_STYLE={opacity:.5};var ROLLER_SUPPORT_STYLE={opacity:1};var ROLLER_SUPPORT_TEMP_STYLE={opacity:.5};var LOAD_TEMP_STYLE={stroke:"#333333","stroke-width":3,"stroke-opacity":.5,"stroke-linejoin":"round"};var LOAD_STYLE={"stroke-opacity":1};var MEMBER_RECT_TEMP_STYLE={fill:"#0099FF","fill-opacity":.5,stroke:"#0099FF","stroke-width":1};var MEMBER_CIRCLE_TEMP_STYLE={fill:"#999999","fill-opacity":.5,stroke:"#999999","stroke-width":1};var MEMBER_CIRCLE_MOUSEOVER_STYLE={fill:"#66FF33","fill-opacity":.5,stroke:"#999999","stroke-width":2};var MEMBER_CIRCLE_STYLE={fill:"#999999","fill-opacity":1,stroke:"#999999","stroke-width":1};var MEMBER_RECT_STYLE={"fill-opacity":1};$(document).ready(function(){function Z(a,b,c){var d='<div id="dialog-message" title="'+a+'"><p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 50px 0;"></span>'+b+"</p><p>"+c+"</p></div>";$("#container").append(d);$("#dialog:ui-dialog").dialog("destroy");$("#dialog-message").dialog({draggable:false,resizable:false,modal:true,buttons:{Ok:function(){$(this).dialog("close")}}})}function _(){var d='<div id="dialog-form" title="Welcome"><p>Please specify the maximum length or width (whichever is longer) of your structure and the unit you will be using:</p><p><label for="length">Length: </label><input id="scale_length" name="length" value="600" type="text" /><label for="unit">  Unit: </label><input id="scale_unit" name="unit" value="m" type="text" /></p><p id="tips"></p></div>';$("#container").append(d);$("#dialog-form").dialog({draggable:false,resizable:false,width:400,modal:true,buttons:{Start:function(){var d=$("#scale_length").val();if($.isNumeric(d)==true&&parseFloat(d)>0){a=d/b;c=$("#scale_unit").val();$(this).dialog("close")}else{$("#tips").html("* Length must be a positive number").addClass("ui-state-highlight");$("#scale_length").addClass("ui-state-error")}}},close:function(){}})}function ab(){$("#tool_describe").hide();$("#loading").hide("fast");var a=k.image(S,-100,-100,K,L);var b=k.image(W,-100,-100,K,L);a.remove();b.remove();_()}function bb(a,b,c){if(j!=a){$("#left_bar > .button_down").removeClass("button_down").addClass("button_up");$(b).removeClass("button_up").addClass("button_down");$("#top_input").html(c)}j=a;k.getById(T).hide();k.getById(M).hide()}function cb(a,b){var c=$(a).offset();$("#tool_describe").css({left:c.left+40,top:c.top+5,width:"auto",height:"auto"});$("#tool_describe").text(b);$("#tool_describe").show("fast")}function db(){var a=O;var b=P;var c=k.image(R,a,b,K,L);c.attr(PIN_SUPPORT_TEMP_STYLE);M=c.id;var d=k.image(V,a,b,K,L);d.attr(ROLLER_SUPPORT_TEMP_STYLE);T=d.id}function eb(){try{var a;for(a in x){var b=y[x[a]].x1+"Y"+y[x[a]].y1;var c=y[x[a]].x2+"Y"+y[x[a]].y2;if(X.indexOf(b)==-1){X[X.length]=b}if(X.indexOf(c)==-1){X[X.length]=c}}var d=X.length;var e=X;for(a=0;a<d;a++){var f=e[a].split("Y")[0];var g=e[a].split("Y")[1];var h=String.fromCharCode(a+65);var i={font:"20px Arial",opacity:1};var j=k.text(f-15,g-15,h).attr(i).attr({fill:"#333333"});Y[a]=j.id}}catch(l){alert("An error has occured while labeling the structure. Click 'Ok' to continue."+"\n\n"+"Error Message: "+l.message)}}function fb(){try{var a;for(a in Y){k.getById(Y[a]).remove()}Y=new Array;X=new Array}catch(b){alert("An error has occured while removing the labels. Click 'Ok' to continue."+"\n\n"+"Error Message: "+b.message)}}var a=1;var b=600;var c="m";var d=1;var e=2;var f=3;var g=4;var h=5;var j=-1;var k=Raphael("canvas",700,670);var l=2;var m;var n;var o=-1;var p=-1;var q;var r;var s=-1;var t=-1;var u=false;var v;var w;var x=new Array;var y=new Array;var z=4;var A=7;var B=2;var C=60;var D;var E;var F=new Array;var G=0;var H=10;var I=5;var J=-1;var K=30;var L=30;var M;var N;var O=-100;var P=-100;var Q=new Array;var R="/trusssolver/pic/pin_pic.gif";var S="/trusssolver/pic/pin_pic_selected.gif";var T;var U=new Array;var V="/trusssolver/pic/roller_pic.gif";var W="/trusssolver/pic/roller_pic_selected.gif";var X=new Array;var Y=new Array;$(document).keydown(function(a){if(a.which==16){u=true}});$(document).keyup(function(a){if(a.which==16){u=false}});$("#button_member").click(function(){bb(e,"#button_member",'<div class="top_box">(x1: <input class="top_coor_input" name="x1" type="text" readonly="true"/>, y1: <input class="top_coor_input" name="y1" type="text" readonly="true"/>) (x2: <input class="top_coor_input" name="x2" type="text" readonly="true"/>, y2: <input class="top_coor_input" name="y2" type="text" readonly="true"/>)</div><div class="top_box">Length: <input class="top_num_input" name="length" type="text" />'+c+'  Angle: <input class="top_num_input" name="angle" type="text" /><button name="set_member" type="button">set</button></div>')}).mouseenter(function(){cb("#button_member","Member")}).mouseleave(function(){$("#tool_describe").stop().hide(25)});$("#button_select").click(function(){bb(d,"#button_select",'<div class="top_box">(x: <input class="top_coor_input" name="x1" type="text" readonly="true"/>, y: <input class="top_coor_input" name="y1" type="text" readonly="true"/>)</div>')}).mouseenter(function(){cb("#button_select","Select")}).mouseleave(function(){$("#tool_describe").stop().hide(25)});$("#button_pin_support").click(function(){bb(f,"#button_pin_support",'<div class="top_box">(x: <input class="top_coor_input" name="x1" type="text" readonly="true"/>, y: <input class="top_coor_input" name="y1" type="text" readonly="true"/>)</div>');k.getById(M).show()}).mouseenter(function(){cb("#button_pin_support","Pin Support")}).mouseleave(function(){$("#tool_describe").stop().hide(25)});$("#button_roller_support").click(function(){bb(g,"#button_roller_support",'<div class="top_box">(x: <input class="top_coor_input" name="x1" type="text" readonly="true"/>, y: <input class="top_coor_input" name="y1" type="text" readonly="true"/>)</div>');k.getById(T).show()}).mouseenter(function(){cb("#button_roller_support","Roller Support")}).mouseleave(function(){$("#tool_describe").stop().hide(25)});$("#button_load").click(function(){bb(h,"#button_load",'<div class="top_box">(x: <input class="top_coor_input" name="x1" type="text" readonly="true"/>, y: <input class="top_coor_input" name="y1" type="text" readonly="true"/>)</div><div class="top_box">Magnitute: <input class="top_num_input" name="magnitute" type="text" />Angle: <input class="top_num_input" name="angle" type="text" /><button name="set_load" type="button">set</button></div>')}).mouseenter(function(){cb("#button_load","Load")}).mouseleave(function(){$("#tool_describe").stop().hide(25)});ab();db();$("#b_solve").click(function(a){try{a.preventDefault();fb();if(x.length==0){Z("Error - Truss Solver","Please add members using the <b>Member</b> tool on the left panel.","")}else if(F.length==0){Z("Error - Truss Solver","Please set the loads of the structure using the <b>Load</b> tool on the left panel.","")}else if(Q.length+U.length==0){Z("Error - Truss Solver","Please add supports using the <b>Support</b> tool on the left panel.","")}else{var b=x.length;var c=F.length;var d=Q.length;var e=U.length;var f="";f=f+"n_m="+b+"&";f=f+"n_l="+c+"&";f=f+"n_ps="+d+"&";f=f+"n_rs="+e+"&";var g=0;for(g=0;g<b;g++){f=f+"m"+g+"x1="+y[x[g]].x1+"&";f=f+"m"+g+"y1="+y[x[g]].y1+"&";f=f+"m"+g+"x2="+y[x[g]].x2+"&";f=f+"m"+g+"y2="+y[x[g]].y2+"&"}for(g=0;g<d;g++){f=f+"ps"+g+"x="+y[Q[g]].x+"&";f=f+"ps"+g+"y="+y[Q[g]].y+"&"}for(g=0;g<e;g++){f=f+"rs"+g+"x="+y[U[g]].x+"&";f=f+"rs"+g+"y="+y[U[g]].y+"&"}for(g=0;g<c;g++){f=f+"l"+g+"x="+y[F[g]].x+"&";f=f+"l"+g+"y="+y[F[g]].y+"&";f=f+"l"+g+"a="+y[F[g]].load_angle+"&";f=f+"l"+g+"m="+y[F[g]].load_mag+"&"}f=f+"end=1";var h;if(window.XMLHttpRequest){h=new XMLHttpRequest}else{h=new ActiveXObject("Microsoft.XMLHTTP")}h.onreadystatechange=function(){if(h.readyState==4&&h.status==200){var a=h.responseText;if(a.indexOf("Error")==-1){var b=a.split("S");var c=b[0].split("_");var d=b[1].split("_");var e;var f=new Array;var g=new Array;var i=c.length;for(e=0;e<i;e++){f[e]=new Array;f[e][0]=c[e].split("&")[0];f[e][1]=c[e].split("&")[1]}i=d.length;for(e=0;e<i;e++){g[e]=new Array;g[e][0]=d[e].split("&")[0];g[e][1]=d[e].split("&")[1]}eb();var j='<table id="member"><tr><th colspan="3">Member</th></tr>';for(e=0;e<x.length;e++){var k=y[x[e]].x1+"Y"+y[x[e]].y1;var l=y[x[e]].x2+"Y"+y[x[e]].y2;var m=String.fromCharCode(parseInt(X.indexOf(k))+65);var n=String.fromCharCode(parseInt(X.indexOf(l))+65);j=j+'<tr><td class="id">'+m+" "+n+"</td>"+'<td class="value">'+f[e][0]+"</td>";var o;if(f[e][1]==1){o="C"}else{o="T"}j=j+'<td class="type">'+o+"</td></tr>"}j=j+'</table><table id="support"><tr><th colspan="3">Support</th></tr>';for(e=0;e<Q.length;e++){var p=y[Q[e]].x+"Y"+y[Q[e]].y;var q=String.fromCharCode(parseInt(X.indexOf(p))+65);j=j+'<tr><td rowspan="2" class="id">'+q+'</td><td class="type">V</td>'+'<td class="value">'+g[e][1]+'</td></tr><tr><td class="type">H</td><td class="value">'+g[e][0]+"</td></tr>"}for(e=0;e<U.length;e++){var p=y[U[e]].x+"Y"+y[U[e]].y;var q=String.fromCharCode(parseInt(X.indexOf(p))+65);j=j+'<tr><td rowspan="2" class="id">'+q+'</td><td class="type">V</td>'+'<td class="value">'+g[e+Q.length][1]+'</td></tr><tr><td class="type">H</td><td class="value">'+g[e+Q.length][0]+"</td></tr>"}j=j+"</table>";$("#right_bar").html(j)}else{Z("Error - Truss Solver","This structure is statically indeterminate.","Please review your structure for missing or misplaced parts")}}};h.open("POST","/trusssolver/solve",true);h.setRequestHeader("Content-type","application/x-www-form-urlencoded");h.send(f)}}catch(i){alert("Error - Truss Solver","An error has occured while solving the structure. Click 'Ok' to continue."+"\n\n"+"Error Message: "+i.message)}});$("#canvas").click(function(b){try{if(j==d){for(i in x){k.getById(x[i]).attr({fill:MEMBER_FILL_COLOR})}for(i in Q){k.getById(Q[i]).attr({src:R})}for(i in U){k.getById(U[i]).attr({src:V})}for(i in F){k.getById(F[i]).attr({stroke:LOAD_STROKE_COLOR})}J=-1;if(k.getElementByPoint(b.pageX,b.pageY)!=null){J=k.getElementByPoint(b.pageX,b.pageY).id;if(x.indexOf(k.getElementByPoint(b.pageX,b.pageY).id)!=-1){k.getById(J).attr({fill:SELECTED_COLOR});$("#top_input").html('<div class="top_box">(x1: <input class="top_coor_input" name="x1" type="text" readonly="true"/>, y1: <input class="top_coor_input" name="y1" type="text" readonly="true"/>) (x2: <input class="top_coor_input" name="x2" type="text" readonly="true"/>, y2: <input class="top_coor_input" name="y2" type="text" readonly="true"/>)</div><div class="top_box">Length: <input class="top_num_input" name="length" type="text" readonly="true"/>Angle: <input class="top_num_input" name="angle" type="text" readonly="true"/></div>');var c=y[J].x1;var u=y[J].y1;var E=y[J].x2;var M=y[J].y2;$('input[name="length"]').val(a*Math.sqrt((c-E)*(c-E)+(u-M)*(u-M)));$('input[name="x1"]').val(y[J].x1);$('input[name="y1"]').val(y[J].y1);$('input[name="x2"]').val(y[J].x2);$('input[name="y2"]').val(y[J].y2);$('input[name="angle"]').val(360-Raphael.angle(E,M,c,u))}else if(Q.indexOf(k.getElementByPoint(b.pageX,b.pageY).id)!=-1){k.getById(J).attr({src:S});$("#top_input").html(" ")}else if(U.indexOf(k.getElementByPoint(b.pageX,b.pageY).id)!=-1){k.getById(J).attr({src:W});$("#top_input").html(" ")}else if(F.indexOf(k.getElementByPoint(b.pageX,b.pageY).id)!=-1){k.getById(J).attr({stroke:SELECTED_COLOR});$("#top_input").html('<div class="top_box">(x: <input class="top_coor_input" name="x1" type="text" readonly="true"/>, y: <input class="top_coor_input" name="y1" type="text" readonly="true"/>)</div><div class="top_box">Magnitute: <input class="top_num_input" name="magnitute" type="text" readonly="true"/>Angle: <input class="top_num_input" name="angle" type="text" readonly="true"/>');$('input[name="magnitute"]').val(y[J].load_mag);$('input[name="angle"]').val(y[J].load_angle);$('input[name="x1"]').val(y[J].x);$('input[name="y1"]').val(y[J].y)}else{J=-1}}$(document).keydown(function(a){if(a.which==46||a.which==8){try{a.preventDefault();if(J!=-1){fb();if(x.indexOf(J)!=-1){var b=x.indexOf(J);x.splice(b,1);var c=new Array(k.getElementsByPoint(y[J].x1,y[J].y1),k.getElementsByPoint(y[J].x2,y[J].y2));var d=0;for(d=0;d<=1;d++){c[d].forEach(function(a){if(y[a.id].type==TYPE_CIRCLE){y[a.id]=null;a.remove();return false}})}k.getById(J).remove();y[J]=null}else if(Q.indexOf(J)!=-1){var b=Q.indexOf(J);Q.splice(b,1);k.getById(J).remove();y[J]=null}else if(U.indexOf(J)!=-1){var b=U.indexOf(J);U.splice(b,1);k.getById(J).remove();y[J]=null}else if(F.indexOf(J)!=-1){var b=F.indexOf(J);F.splice(b,1);k.getById(J).remove();y[J]=null}}}catch(e){alert("An error has occured while deleting an element. Click 'Ok' to continue."+"\n\n"+"Error Message: "+e.message)}}})}else if(j==f||j==g){if(o!=-1&&p!=-1){var O=false;var P=k.getElementsByPoint(cX(o),cY(p)+1);P.forEach(function(a){if(y[a.id].type==TYPE_PIN_SUPPORT||y[a.id].type==TYPE_ROLLER_SUPPORT){O=true;return false}});if(O==false){fb();var T=cX(o);var X=cY(p);if(j==f){var Y=k.image(R,T-K/2,X,K,L);Y.attr(PIN_SUPPORT_STYLE);N=Y.id;Q.push(Y.id);var Z=new coor(TYPE_PIN_SUPPORT,cX(o),cY(p));y[N]=Z}else if(j==g){var Y=k.image(V,T-K/2,X,K,L);Y.attr(ROLLER_SUPPORT_STYLE);N=Y.id;U.push(Y.id);var _=new coor(TYPE_ROLLER_SUPPORT,cX(o),cY(p));y[N]=_}}}}else if(j==h){if((o!=-1||p!=-1)&&B==2){fb();B=2/B;var ab="M"+cX(m)+","+cY(n);var bb="H"+cX(m+C);var cb="L"+cX(m+C-I)+","+cY(n-I);var db="L"+cX(m+C)+","+cY(n);var eb="L"+cX(m+C-I)+","+cY(n+I);var gb=k.path(ab+bb+cb+db+eb);gb.attr(LOAD_TEMP_STYLE);D=gb.id}else if(B==1){B=2/B;k.getById(D).attr(LOAD_STYLE);var hb=new coor(TYPE_LOAD,cX(m),cY(n),G,H);y[D]=hb;F.push(D)}}else if(j==e){fb();l=2/l;var ib=1;if(l==1){var jb=k.rect(cX(m),cY(n)-z/2,ib,z).attr(MEMBER_RECT_TEMP_STYLE);var kb=k.circle(cX(m),cY(n),A).attr(MEMBER_CIRCLE_TEMP_STYLE);var lb=new coor(TYPE_CIRCLE,cX(m),cY(n));y[kb.id]=lb;kb.mouseover(function(){if(j==e||j==f||j==g||j==h){kb.attr(MEMBER_CIRCLE_MOUSEOVER_STYLE);if(l==2){o=cXr(y[kb.id].x);p=cYr(y[kb.id].y)}else if(l==1){s=cXr(y[kb.id].x);t=cYr(y[kb.id].y)}}});kb.mouseout(function(){kb.attr(MEMBER_CIRCLE_STYLE);o=-1;p=-1;s=-1;t=-1});v=jb.id;w=kb.id}else if(l==2){if(m!=q||n!=r){k.getById(v).attr(MEMBER_RECT_STYLE);k.getById(w).attr(MEMBER_CIRCLE_STYLE);var mb=k.circle(cX(q),cY(r),A).attr(MEMBER_CIRCLE_STYLE);var nb=new coor(TYPE_MEMBER,cX(m),cY(n),cX(q),cY(r));var ob=new coor(TYPE_CIRCLE,cX(q),cY(r));y[v]=nb;y[mb.id]=ob;x.push(v);mb.mouseover(function(){if(j==e||j==f||j==g||j==h){mb.attr(MEMBER_CIRCLE_MOUSEOVER_STYLE);if(l==2){o=cXr(y[mb.id].x);p=cYr(y[mb.id].y)}else if(l==1){s=cXr(y[mb.id].x);t=cYr(y[mb.id].y)}}});mb.mouseout(function(){mb.attr(MEMBER_CIRCLE_STYLE);o=-1;p=-1;s=-1;t=-1})}}}}catch(pb){alert("An error has occured. Click 'Ok' to continue."+"\n\n"+"Error Message: "+pb.message)}});$("#canvas").mousemove(function(b){try{if(j==f||j==g){$('input[name="x1"]').val(cX(m));$('input[name="y1"]').val(cY(n));if(o==-1||p==-1){m=b.pageX;n=b.pageY;if(j==f){k.getById(M).transform("T"+(cX(m-O)-K/2)+","+cY(n-P));k.getById(M).attr(PIN_SUPPORT_TEMP_STYLE)}else{k.getById(T).transform("T"+(cX(m-O)-K/2)+","+cY(n-P));k.getById(T).attr(ROLLER_SUPPORT_TEMP_STYLE)}}else{m=o;n=p;if(j==f){k.getById(M).transform("T"+(cX(m-O)-K/2)+","+cY(n-P));k.getById(M).attr(PIN_SUPPORT_STYLE)}else{k.getById(T).transform("T"+(cX(m-O)-K/2)+","+cY(n-P));k.getById(T).attr(ROLLER_SUPPORT_STYLE)}}}else if(j==h){$('input[name="x1"]').val(cX(m));$('input[name="y1"]').val(cY(n));if(B==2){if(o==-1||p==-1){m=b.pageX;n=b.pageY}else{m=o;n=p}}else if(B==1){q=b.pageX;r=b.pageY;if(u==true){var c=Math.round(Raphael.angle(q,r,m,n)/15)*15;q=m+C*Math.cos(c/180*Math.PI);r=n+C*Math.sin(c/180*Math.PI);var d="R"+c+","+cX(m)+","+cY(n);k.getById(D).transform(d)}else{var d="R"+Raphael.angle(q,r,m,n)+","+cX(m)+","+cY(n);k.getById(D).transform(d)}$('input[name="magnitute"]').val(H);$('input[name="angle"]').val(360-Raphael.angle(q,r,m,n));G=360-Raphael.angle(q,r,m,n)}$('input[name="magnitute"]').change(function(){if(B==1){H=$(this).val()}});$('input[name="angle"]').change(function(){if(B==1){G=$(this).val();var a=360-$(this).val();d="R"+a+","+cX(m)+","+cY(n);k.getById(D).transform(d)}});$('button[name="set_load"]').click(function(a){a.preventDefault();if(B==1){$("#canvas").click()}})}else if(j==e){$('input[name="x1"]').val(cX(m));$('input[name="y1"]').val(cY(n));if(l==1){if(s==-1||t==-1){q=b.pageX;r=b.pageY}else{q=s;r=t}var i=Math.sqrt((m-q)*(m-q)+(n-r)*(n-r))-3;var w="S"+i+","+"1"+","+cX(m)+","+cY(n);if(u==true){var c=Math.round(Raphael.angle(q,r,m,n)/15)*15;q=m+i*Math.cos(c/180*Math.PI);r=n+i*Math.sin(c/180*Math.PI);var d="R"+c+","+cX(m)+","+cY(n);k.getById(v).transform(d+w)}else{var d="R"+Raphael.angle(q,r,m,n)+","+cX(m)+","+cY(n);k.getById(v).transform(d+w)}$('input[name="length"]').change(function(){if(l==1){var b=Raphael.angle(q,r,m,n);i=$(this).val()/a;q=m+i*Math.cos(b/180*Math.PI);r=n+i*Math.sin(b/180*Math.PI);w="S"+i+","+"1"+","+cX(m)+","+cY(n);d="R"+Raphael.angle(q,r,m,n)+","+cX(m)+","+cY(n);k.getById(v).transform(d+w);$('input[name="x2"]').val(cX(q));$('input[name="y2"]').val(cY(r))}});$('input[name="angle"]').change(function(){if(l==1){var a=360-$(this).val();d="R"+a+","+cX(m)+","+cY(n);q=m+i*Math.cos(a/180*Math.PI);r=n+i*Math.sin(a/180*Math.PI);k.getById(v).transform(d+w);$('input[name="x2"]').val(cX(q));$('input[name="y2"]').val(cY(r))}});$('button[name="set_member"]').click(function(a){a.preventDefault();if(l==1){$("#canvas").click()}});$('input[name="x2"]').val(cX(q));$('input[name="y2"]').val(cY(r));$('input[name="length"]').val(i*a);$('input[name="angle"]').val(360-Raphael.angle(q,r,m,n))}else if(l==2){if(o==-1||p==-1){m=b.pageX;n=b.pageY}else{m=o;n=p}}}}catch(x){alert("An error has occured. Click 'Ok' to continue."+"\n\n"+"Error Message: "+x.message)}})})